<?php // -*-PHP-*-
require ('./common.inc.php');

$key = GET_ldapFilterSafe("key");

$all_groups = array();
if ($cn = removePrefixOrNULL($key, "groups-")) {
  $all_groups = getGroupsFromGroupsDn(array(seeAlso_filter($cn)));
} else if ($supannCodeEntite = removePrefixOrNULL($key, "structures-")) {

  // handle key like structures-U05-affiliation-student:
  $supannCodeEntite = preg_replace("/-affiliation-.*/", "", $supannCodeEntite);

  $ou = "ou=$supannCodeEntite," . $ALT_STRUCTURES_DN;
  $diploma = getGroupsFromDiplomaDn(array("(seeAlso=$ou)"));
  $groups = getGroupsFromGroupsDn(array("(seeAlso=$ou)"));
  $all_groups = array_merge($diploma, $groups);
} else if ($diploma = removePrefixOrNULL($key, "diploma-")) {
  $ou = "ou=$diploma," . $DIPLOMA_DN;
  $diploma = getGroupsFromDiplomaDn(array("(seeAlso=$ou)"));
  $groups = getGroupsFromGroupsDn(array("(seeAlso=$ou)"));
  $all_groups = array_merge($diploma, $groups);
} else if ($diploma = removePrefixOrNULL($key, "diplomaPrev-")) {
  $ou = "ou=$diploma," . $DIPLOMA_PREV_DN;
  $diploma = getGroupsFromDiplomaDn(array("(seeAlso=$ou)"));
  $groups = getGroupsFromGroupsDn(array("(seeAlso=$ou)"));
  $all_groups = array_merge($diploma, $groups);
} else if ($affiliation = removePrefixOrNULL($key, "affiliation-")) {
  $groupsStructures = getGroupsFromStructuresDn(array("(businessCategory=pedagogy)"));
  $all_groups = getGroupsFromAffiliationAndStructures($affiliation, $groupsStructures);  
} else {
  error("invalid group key $key");
}
remove_rawKey($all_groups);
echoJson($all_groups);

?>
